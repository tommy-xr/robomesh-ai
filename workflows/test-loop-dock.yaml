version: 2
metadata:
  name: Counter Loop Test (Dock-Based)
  description: Simple loop using dock slots for iteration control
nodes:
  - id: trigger
    type: trigger
    position:
      x: 100
      "y": 100
    data:
      nodeType: trigger
      label: Start
      triggerType: manual
      outputs:
        - name: timestamp
          type: string
        - name: type
          type: string
        - name: text
          type: string
        - name: params
          type: json
  - id: target-value
    type: constant
    position:
      x: 100
      "y": 200
    data:
      nodeType: constant
      label: Target
      valueType: number
      value: 5
      outputs:
        - name: value
          type: number
  - id: count-loop
    type: loop
    position:
      x: 300
      "y": 50
    style:
      width: 500
      height: 300
    data:
      label: Count to Target
      nodeType: loop
      maxIterations: 10
      inputs:
        - name: trigger
          type: string
          required: false
        - name: target
          type: number
      outputs:
        - name: final_count
          type: number
      dockSlots:
        - name: iteration
          type: iteration
          valueType: number
          label: Iteration
        - name: continue
          type: continue
          valueType: boolean
          label: Continue
        - name: count
          type: feedback
          valueType: number
          label: Count
  - id: counter
    type: shell
    parentId: count-loop
    extent: parent
    position:
      x: 100
      "y": 50
    data:
      nodeType: shell
      label: Increment Counter
      script: |
        TARGET={{ inputs.target }}
        PREV={{ inputs.prev_count }}
        ITER={{ inputs.iteration }}
        # Handle null/empty prev value
        if [ "$PREV" = "null" ] || [ -z "$PREV" ]; then
          PREV=0
        fi
        COUNT=$((PREV + 1))
        echo "Iteration $ITER: Count = $COUNT / $TARGET"
        if [ $COUNT -lt $TARGET ]; then
          echo "CONTINUE=true"
        else
          echo "CONTINUE=false"
        fi
      inputs:
        - name: target
          type: number
        - name: prev_count
          type: number
        - name: iteration
          type: number
        - name: input
          type: any
          required: false
          description: Generic input for template interpolation
      outputs:
        - name: count
          type: number
          extract:
            type: regex
            pattern: Count = (\d+)
        - name: should_continue
          type: boolean
          extract:
            type: regex
            pattern: CONTINUE=(true|false)
        - name: output
          type: string
          description: Combined stdout output
        - name: stdout
          type: string
          description: Standard output
        - name: stderr
          type: string
          description: Standard error
        - name: exitCode
          type: number
          description: Exit code (0 = success)
edges:
  - id: trigger-to-loop
    source: trigger
    target: count-loop
    sourceHandle: output:text
    targetHandle: input:trigger
  - id: constant-to-loop
    source: target-value
    target: count-loop
    sourceHandle: output:value
    targetHandle: input:target
  - id: loop-target-to-counter
    source: count-loop
    target: counter
    sourceHandle: input:target:internal
    targetHandle: input:target
  - id: dock-iter-to-counter
    source: count-loop
    target: counter
    sourceHandle: dock:iteration:output
    targetHandle: input:iteration
  - id: dock-count-prev-to-counter
    source: count-loop
    target: counter
    sourceHandle: dock:count:prev
    targetHandle: input:prev_count
  - id: counter-to-dock-count
    source: counter
    target: count-loop
    sourceHandle: output:count
    targetHandle: dock:count:current
  - id: counter-to-dock-continue
    source: counter
    target: count-loop
    sourceHandle: output:should_continue
    targetHandle: dock:continue:input
