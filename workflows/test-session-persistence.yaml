version: 2
metadata:
  name: Session Persistence Test
  description: Tests agent session persistence by creating a session and then resuming it
nodes:
  - id: trigger
    type: trigger
    position:
      x: 100
      "y": 150
    data:
      label: Start
      nodeType: trigger
      triggerType: manual
      outputs:
        - name: timestamp
          type: string
        - name: type
          type: string
        - name: text
          type: string
        - name: params
          type: json
  - id: first_call
    type: agent
    position:
      x: 350
      "y": 150
    data:
      label: First Call
      nodeType: agent
      runner: claude-code
      model: haiku
      prompt: "Remember this secret code: BLUE42. Just say 'Got it, I remember BLUE42' and nothing else."
      inputs:
        - name: trigger
          type: string
          required: false
        - name: prompt
          type: string
          required: false
          description: Override prompt (optional)
        - name: sessionId
          type: string
          required: false
          description: Session ID to resume (optional)
      outputs:
        - name: output
          type: string
        - name: sessionId
          type: string
        - name: exitCode
          type: number
          description: Exit code (0 = success)
  - id: second_call
    type: agent
    position:
      x: 600
      "y": 150
    data:
      label: Second Call
      nodeType: agent
      runner: claude-code
      model: haiku
      prompt: What was the secret code I told you to remember? Just say the code, nothing else.
      inputs:
        - name: sessionId
          type: string
        - name: prompt
          type: string
          required: false
          description: Override prompt (optional)
      outputs:
        - name: output
          type: string
        - name: sessionId
          type: string
        - name: exitCode
          type: number
          description: Exit code (0 = success)
  - id: verify
    type: shell
    position:
      x: 850
      "y": 150
    data:
      label: Verify
      nodeType: shell
      script: |
        echo "First call output: {{ first_call.output }}"
        echo "Second call output: {{ second_call.output }}"
        echo ""
        if echo "{{ second_call.output }}" | grep -qi "BLUE42"; then
          echo "SUCCESS: Session persistence worked! Agent remembered the code."
          exit 0
        else
          echo "FAILED: Agent did not remember the code from previous session."
          exit 1
        fi
      inputs:
        - name: first_output
          type: string
        - name: second_output
          type: string
        - name: input
          type: any
          required: false
          description: Generic input for template interpolation
      outputs:
        - name: output
          type: string
          description: Combined stdout output
        - name: stdout
          type: string
          description: Standard output
        - name: stderr
          type: string
          description: Standard error
        - name: exitCode
          type: number
          description: Exit code (0 = success)
edges:
  - id: e1
    source: trigger
    target: first_call
    sourceHandle: output:timestamp
    targetHandle: input:trigger
  - id: e2
    source: first_call
    target: second_call
    sourceHandle: output:sessionId
    targetHandle: input:sessionId
  - id: e3
    source: first_call
    target: verify
    sourceHandle: output:output
    targetHandle: input:first_output
  - id: e4
    source: second_call
    target: verify
    sourceHandle: output:output
    targetHandle: input:second_output
